---
title: Next.js App Router
description: Full-featured Next.js App Router example with evlog — enrichers, pipeline, drain, tail sampling, browser drain, and client provider.
navigation:
  title: Next.js
  icon: i-simple-icons-nextdotjs
links:
  - label: Source Code
    icon: i-simple-icons-github
    to: https://github.com/HugoRCD/evlog/tree/main/apps/next-playground
    color: neutral
    variant: subtle
---

A complete Next.js App Router project demonstrating every evlog feature: wide events, structured errors, enrichers, drain pipeline, tail sampling with custom `keep` callback, browser drain, and client-side logging.

## Project Structure

```
apps/next-playground/
├── lib/
│   └── evlog.ts              # Shared evlog config (enrichers, pipeline, drain, keep)
├── app/
│   ├── layout.tsx            # EvlogProvider for client logging
│   ├── page.tsx              # Interactive playground UI (9 sections)
│   ├── api/
│   │   ├── checkout/route.ts       # Wide event: user + cart + payment
│   │   ├── health/route.ts         # Simple health check
│   │   ├── auth/login/route.ts     # Service routing → auth-service
│   │   ├── payment/process/route.ts  # Service routing → payment-service
│   │   ├── booking/create/route.ts   # Service routing → booking-service
│   │   ├── evlog/ingest/route.ts     # Client log ingest endpoint
│   │   └── test/
│   │       ├── wide-event/route.ts        # 6-stage wide event
│   │       ├── success/route.ts           # Async workflow with staged logging
│   │       ├── error/route.ts             # Payment failure with logger.error()
│   │       ├── structured-error/route.ts  # createEvlogError → parseError
│   │       ├── browser-ingest/route.ts    # Browser drain endpoint
│   │       ├── drain/route.ts             # Drain pipeline test
│   │       ├── critical/important/route.ts  # Path-based tail sampling
│   │       └── tail-sampling/
│   │           ├── fast/route.ts    # Head sampling (10%)
│   │           ├── slow/route.ts    # Tail: duration >= 500ms
│   │           ├── error/route.ts   # Tail: status >= 400
│   │           └── premium/route.ts # Custom keep() callback
│   └── middleware.ts
└── package.json
```

## Configuration

The central `lib/evlog.ts` configures everything in one place:

```typescript [lib/evlog.ts]
import type { DrainContext } from 'evlog'
import { createEvlog } from 'evlog/next'
import { createUserAgentEnricher, createRequestSizeEnricher } from 'evlog/enrichers'
import { createDrainPipeline } from 'evlog/pipeline'

const enrichers = [createUserAgentEnricher(), createRequestSizeEnricher()]

const pipeline = createDrainPipeline<DrainContext>({ batch: { size: 5, intervalMs: 2000 } })

const drain = pipeline((batch) => {
  for (const ctx of batch) {
    console.log('[DRAIN]', JSON.stringify(ctx.event))
  }
})

export const { withEvlog, useLogger, log, createEvlogError } = createEvlog({
  service: 'next-playground',
  sampling: {
    rates: { info: 10 },
    keep: [
      { status: 400 },
      { duration: 500 },
      { path: '/api/test/tail-sampling/**' },
      { path: '/api/test/critical/**' },
      { path: '/api/test/drain' },
    ],
  },
  routes: {
    '/api/auth/**': { service: 'auth-service' },
    '/api/checkout': { service: 'checkout-service' },
    '/api/checkout/**': { service: 'checkout-service' },
    '/api/payment/**': { service: 'payment-service' },
    '/api/booking/**': { service: 'booking-service' },
  },
  keep: (ctx) => {
    const user = ctx.context.user as { premium?: boolean } | undefined
    if (user?.premium) ctx.shouldKeep = true
  },
  enrich: (ctx) => {
    for (const enricher of enrichers) enricher(ctx)
    ctx.event.playground = {
      name: 'next-playground',
      enrichedAt: new Date().toISOString(),
    }
  },
  drain,
})
```

## Route Handler

Every route handler is wrapped with `withEvlog()`:

```typescript [app/api/checkout/route.ts]
import { withEvlog, useLogger } from '@/lib/evlog'

export const POST = withEvlog(async () => {
  const log = useLogger()

  log.set({
    user: { id: 'user_123', email: 'demo@example.com', plan: 'enterprise' },
  })

  log.set({
    cart: { items: 5, total: 24999, currency: 'USD' },
  })

  log.set({
    payment: { method: 'card', cardBrand: 'visa', cardLast4: '4242' },
  })

  log.info('Processing payment')

  return Response.json({ success: true, orderId: 'ord_abc123' })
})
```

## Server Actions

```typescript [app/actions.ts]
'use server'
import { withEvlog, useLogger } from '@/lib/evlog'

export const checkout = withEvlog(async (formData: FormData) => {
  const log = useLogger()
  log.set({ action: 'checkout', source: 'server-action' })
  log.set({ item: formData.get('item') })
  return { success: true }
})
```

## Middleware

```typescript [middleware.ts]
import { evlogMiddleware } from 'evlog/next'

export const middleware = evlogMiddleware()

export const config = {
  matcher: ['/api/:path*'],
}
```

::callout{icon="i-lucide-info" color="info"}
Next.js 16 renames `middleware.ts` to `proxy.ts`. The import stays the same.
::

## Client Provider

```tsx [app/layout.tsx]
import { EvlogProvider } from 'evlog/next/client'

export default function Layout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        <EvlogProvider service="next-playground" transport={{ enabled: true }}>
          {children}
        </EvlogProvider>
      </body>
    </html>
  )
}
```

## Client Logging

```tsx [app/components/Example.tsx]
'use client'
import { log, setIdentity, clearIdentity } from 'evlog/next/client'

export function Example() {
  return (
    <div>
      <button onClick={() => setIdentity({ userId: 'usr_123' })}>Login</button>
      <button onClick={() => log.info({ action: 'click' })}>Track</button>
      <button onClick={() => clearIdentity()}>Logout</button>
    </div>
  )
}
```

## Browser Drain

Send structured log events from the browser to a custom endpoint:

```typescript
import { createBrowserLogDrain } from 'evlog/browser'

const drain = createBrowserLogDrain({
  drain: { endpoint: '/api/test/browser-ingest' },
  pipeline: { batch: { size: 5, intervalMs: 2000 } },
})

// Push events
drain(drainEvent)

// Manual flush
await drain.flush()
```

The server endpoint receives batched `DrainContext[]`:

```typescript [app/api/test/browser-ingest/route.ts]
export async function POST(request: Request) {
  const body = await request.json()

  if (Array.isArray(body)) {
    for (const entry of body) {
      console.log('[BROWSER DRAIN]', JSON.stringify(entry))
    }
  }

  return new Response(null, { status: 204 })
}
```

## Run the Playground

```bash
git clone https://github.com/HugoRCD/evlog.git
cd evlog
bun install
bun run dev:next
```

Open [http://localhost:3001](http://localhost:3001) and explore all 9 sections. Watch the terminal for wide events, batched drain output, and tail sampling behavior.

::card-group
  :::card
  ---
  icon: i-simple-icons-github
  title: Source Code
  to: https://github.com/HugoRCD/evlog/tree/main/apps/next-playground
  ---
  Browse the complete Next.js playground source on GitHub.
  :::
::
